# ================= User settings =================
MOLCAS := ./run.sh
SCRIPT := /home/taras/.local/bin/cas

# ================= Directories =================
STATUS_DIR := status

# ================= Steps =================
STEPS := gateway seward scf rasscf caspt2

# ================= Optional CASSCF input =================
# Priority: rasscf.inp > casscf.inp > cas.inp
CASSCF_INP := $(firstword \
	$(wildcard rasscf.inp) \
	$(wildcard casscf.inp) \
	$(wildcard cas.inp))


# Priority: caspt2.inp > pt2.inp
CASPT2_INP := $(firstword \
	$(wildcard caspt2.inp) \
	$(wildcard pt2.inp))


# Priority: localisation.inp > localization.inp > loc.inp
LOC_INP := $(firstword \
	$(wildcard localisation.inp) \
	$(wildcard localization.inp) \
	$(wildcard loc.inp))

# ================= Default target =================
.PHONY: all
all: $(STATUS_DIR)/caspt2.done

# ================= Ensure status directory exists =================
$(STATUS_DIR):
	mkdir -p $@

# ================= Script generation =================
run.sh:
	$(SCRIPT) shrek
	touch $@

# ================= Dependency chain =================
$(STATUS_DIR)/gateway.done: gateway.inp run.sh | $(STATUS_DIR)
	$(MOLCAS) gateway.inp
	touch $@

$(STATUS_DIR)/seward.done: seward.inp $(STATUS_DIR)/gateway.done run.sh | $(STATUS_DIR)
	$(MOLCAS) seward.inp
	touch $@

$(STATUS_DIR)/scf.done: scf.inp $(STATUS_DIR)/gateway.done $(STATUS_DIR)/seward.done run.sh | $(STATUS_DIR)
	$(MOLCAS) scf.inp
	touch $@

$(STATUS_DIR)/rasscf.done: $(CASSCF_INP) \
	$(STATUS_DIR)/gateway.done \
	$(STATUS_DIR)/seward.done \
	run.sh | $(STATUS_DIR)
	@if [ -z "$(CASSCF_INP)" ]; then \
		echo "ERROR: No CASSCF input found (rasscf.inp, casscf.inp, or cas.inp)"; \
	    exit 1; \
	fi
	$(MOLCAS) $(CASSCF_INP)
	touch $@

$(STATUS_DIR)/caspt2.done: $(CASPT2_INP) \
	$(STATUS_DIR)/gateway.done \
	$(STATUS_DIR)/seward.done \
	$(STATUS_DIR)/rasscf.done \
	run.sh | $(STATUS_DIR)
	@if [ -z "$(CASPT2_INP)" ]; then \
		echo "ERROR: No CASPT2 input found (caspt2.inp, pt2.inp)"; \
	    exit 1; \
	fi
	$(MOLCAS) $(CASPT2_INP)
	touch $@

$(STATUS_DIR)/loc.done: $(LOC_INP) \
	$(STATUS_DIR)/gateway.done \
	$(STATUS_DIR)/seward.done \
	run.sh | $(STATUS_DIR)
	@if [ -z "$(LOC_INP)" ]; then \
	    echo "ERROR: No LOCALISATION input found (localisation.inp, localization.inp, loc.inp)"; \
	    exit 1; \
	fi
	$(MOLCAS) $(LOC_INP)
	touch $@

$(STATUS_DIR)/rassi.done: rassi.inp \
	$(STATUS_DIR)/gateway.done \
	$(STATUS_DIR)/seward.done \
	$(STATUS_DIR)/rasscf.done \
	run.sh | $(STATUS_DIR)
	$(MOLCAS) rassi.inp
	touch $@

# ================= Alias targets =================
gateway: $(STATUS_DIR)/gateway.done
seward: $(STATUS_DIR)/seward.done
scf: $(STATUS_DIR)/scf.done
rasscf: $(STATUS_DIR)/rasscf.done
cas: $(STATUS_DIR)/rasscf.done
caspt2: $(STATUS_DIR)/caspt2.done
pt2: $(STATUS_DIR)/caspt2.done
loc: $(STATUS_DIR)/loc.done
rassi: $(STATUS_DIR)/rassi.done

# ================= Safety =================
.DELETE_ON_ERROR:

# ================= Cleanup =================
.PHONY: clean
clean:
	rm -f *.out *.log *.status *.err *.xml *.h5 *.JobIph *.RasOrb
	rm -rf $(STATUS_DIR)

.PHONY: distclean
distclean:
	rm -f *.out *.log *.status *.err *.xml *.h5 *.JobIph *.RasOrb 
	rm -rf $(STATUS_DIR)
	rm -rf save
	rm -f run.sh 
	if [ -f SCRATCH_INFO ]; then \
	    xargs rm -rf < SCRATCH_INFO; \
	    rm -f SCRATCH_INFO; \
	fi
