#!/usr/bin/env python3
import os 
import argparse
import sys
import math

def parse_arguments(non_interactive_arguments=None):
    parser = argparse.ArgumentParser(prog='orasp',
                                     description='ORCA spectrum parser')
    parser.add_argument('orca_output', type=open,
                        help='''Output file of the ORCA calculation''')
    parser.add_argument('-o', nargs='?', type=argparse.FileType('w'), metavar='OUTFILE', default=sys.stdout,
                        help='Output of the script. Default is stdout.')
    parser.add_argument('-spectype', choices=['v', 'l', 'f'], 
                        metavar='SPECTYPE', default='l',
                        help='Type of spectrum to plot. v, \
                              and l are velocity, length \
                              transitions. use f for full semiclassical transitions.')
    parser.add_argument('--units', choices=['cm', 'ev', 'nm'], 
                        metavar='UNIT', default='cm',
                        help='Units for the specturm. Default cm')
    parser.add_argument('-noso', action='store_true',
                        help='Do not use spin-orbit.')
    parser.add_argument('-py', type=str, default=False,
                        help='Output in python format. \
                              Optionally can specify the dict name',
                        nargs='?')
    parser.add_argument('--roots-only', action='store_true',
                        help='only print the roots')
    if non_interactive_arguments == None:
        args = parser.parse_args()
    else:
        args = parser.parse_args(non_interactive_arguments)
    args.so = False if args.noso else True
    args.filename = args.orca_output.name
    return args


def get_roots(args):
    roots = {}
    started = 0
    while True: 
        line = next(args.orca_output)
        if 'Using One-Photon Spectroscopy Tool' in line: 
            for i in range(5): next(args.orca_output)
            break
    for line in args.orca_output:
        if not line.split(): break
        rootnum, colon, energy, *rest = line.split()
        roots[rootnum] = energy
    args.roots = roots
    return roots


def parse_orca_spectrum(file_iterator, spec_line):
    spectrum = dict()
    # seek the spectrum desired
    while True:
        current_line = next(file_iterator)
        if spec_line in current_line: 
            for i in range(4): 
                next(file_iterator)
            break 
    # parse the spectrum
    current_line = next(file_iterator)
    while '*' not in current_line and current_line.split():
        init, arrow, final, e_ev, e_cm, wavelength, fosc, matrix_element, *rest = current_line.split()
        init, final = init[:-5], final[:-5]
        init, final = str(int(init) + 1), str(int(final) + 1)
        spectrum[init+arrow+final] = (float(e_cm), float(fosc), float(matrix_element))
        current_line = next(file_iterator)
    return spectrum


def get_spectrum_trdc(args):
    return None

def print_spectrum(args):
    if args.py is False:
        print(f'transition', f'energy_{args.units}', 'osc_str', '<i|mu|f>^2',
              file=args.o, sep=',')
        for k, v in args.spectrum.items():
            print(k, v[0], v[1], v[2], file=args.o, sep=',')
        return
    dict_name = args.spectype if args.py == None else args.py
    print(f'data_{dict_name} = ', '{', file=args.o)
    for k, v in args.spectrum.items():
        print(' '*4, f"'{k}' : ", 
              '{', 
              f"'energy_{args.units}': {v[0]}, 'osc_str': {v[1]}, 'dipole_matrix_element': {v[2]}", 
              '},',
              file=args.o)
    print('}', file=args.o)


def main(non_interactive_arguments=None):
    args = parse_arguments(non_interactive_arguments)
    roots = get_roots(args)
    roots = get_roots(args)
    if not roots:
        return 1
    elif args.roots_only:
        #print roots, convert to cm
        args.orca_output.close()
        [print(_, file=args.o) for _ in args.roots.values()]
        return args.roots
    spec_options = {
        'l': 'TRANSITION ELECTRIC DIPOLE MOMENTS',
        'v': 'TRANSITION VELOCITY DIPOLE MOMENTS',
        'f': 'FULL SEMI-CLASSICAL FORMULATION'
    }
    spec_line = 'SOC CORRECTED ABSORPTION SPECTRUM VIA ' + spec_options[args.spectype] + ' (- Extended -)'
    args.spectrum = parse_orca_spectrum(args.orca_output, spec_line)
    args.orca_output.close()
    if non_interactive_arguments != None and args.o == sys.stdout:
        return args.spectrum
    print_spectrum(args)
    return args.spectrum


if __name__ == '__main__':
    main()
