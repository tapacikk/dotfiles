#!/bin/bash

volume_step=2
brightness_step=5
max_volume=100
notification_timeout=3000 # in milliseconds

# Detect hostname
HOSTNAME=$(hostname)

function is_yoshipad {
    [[ "$HOSTNAME" == "yoshipad" ]]
}


# Uses regex to get volume from pactl
function get_volume {
    pactl get-sink-volume @DEFAULT_SINK@ | grep -Po '[0-9]{1,3}(?=%)' | head -1
}

# Uses regex to get mute status from pactl
function get_mute {
    pactl get-sink-mute @DEFAULT_SINK@ | grep -Po '(?<=Mute: )(yes|no)'
}

# Uses regex to get mic volume from pactl
function get_mic_volume {
    pactl get-source-volume @DEFAULT_SOURCE@ | grep -Po '[0-9]{1,3}(?=%)' | head -1
}

# Gets mic mute status
function get_mic_mute {
    pactl get-source-mute @DEFAULT_SOURCE@ | grep -Po '(?<=Mute: )(yes|no)'
}

# Uses regex to get brightness from xbacklight / brightnessctl (for yoshipad)
function get_brightness_brightnessctl {
    absb=$(brightnessctl g)
    maxb=$(brightnessctl m)
    echo $(( absb * 100 / maxb ))
}

# Get brightness from ddcutil (VCP code 0x10)
function get_brightness_ddcutil {
    # ddcutil outputs something like "Brightness: 30"
    ddcutil getvcp 10 2> /dev/null \
    | awk '/current value/ {print $9}' \
    | sed 's/,//'
}


# Dispatcher brightness getter
function get_brightness {
    if is_yoshipad; then
        get_brightness_brightnessctl
    else
        get_brightness_ddcutil
    fi
}

# Always returns the same icon
function get_brightness_icon {
    brightness_icon=""
}

# Returns a mute icon, a volume-low icon, or a volume-high icon, depending on the volume
function get_volume_icon {
    volume=$(get_volume)
    mute=$(get_mute)
    if [ "$volume" -eq 0 ] || [ "$mute" == "yes" ] ; then
        volume_icon="󰝟"
    elif [ "$volume" -lt 50 ]; then
        volume_icon=" "
    else
        volume_icon=" "
    fi
}

# Brightness setter for ddcutil: absolute value 0–100
function set_brightness_ddcutil {
    newval=$1
    ddcutil setvcp 10 "$newval"
}

# Dispatcher brightness setter
function change_brightness {
    current=$(get_brightness)
    echo CURRENT BRI: $current

    if is_yoshipad; then
        # brightnessctl uses relative %
        if [[ "$1" == "up" ]]; then
            brightnessctl s +$brightness_step%
        else
            brightnessctl s $brightness_step%-
        fi
    else
        # ddcutil needs an absolute value
        if [[ "$1" == "up" ]]; then
            new=$(( current + brightness_step ))
        else
            new=$(( current - brightness_step ))
        fi

        # clamp 0–100
        (( new < 0 )) && new=0
        (( new > 100 )) && new=100

        set_brightness_ddcutil "$new"
    fi
}

# Displays a brightness notification
function show_brightness_notif {
    brightness=$(get_brightness)
    get_brightness_icon
    notify-send -t $notification_timeout -h string:x-dunst-stack-tag:brightness_notif -h int:value:$brightness "$brightness_icon $brightness%"
}


# Displays a volume notification
function show_volume_notif {
    volume=$(get_mute)
    get_volume_icon
    notify-send -t $notification_timeout -h string:x-dunst-stack-tag:volume_notif -h int:value:$volume "$volume_icon $volume%"
}

# ========================= MAIN ============================
case $1 in
    volume_up)
        pactl set-sink-mute @DEFAULT_SINK@ 0
        volume=$(get_volume)
        if [ $(( "$volume" + "$volume_step" )) -gt $max_volume ]; then
            pactl set-sink-volume @DEFAULT_SINK@ $max_volume%
        else
            pactl set-sink-volume @DEFAULT_SINK@ +$volume_step%
        fi
        show_volume_notif
    ;;

    volume_down)
        pactl set-sink-volume @DEFAULT_SINK@ -$volume_step%
        show_volume_notif
    ;;

    volume_mute)
        pactl set-sink-mute @DEFAULT_SINK@ toggle
        show_volume_notif
    ;;

    brightness_up)
        change_brightness up
        show_brightness_notif
    ;;

    brightness_down)
        change_brightness down
        show_brightness_notif
    ;;
esac

